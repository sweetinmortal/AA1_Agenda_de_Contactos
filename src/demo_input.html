<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo Agenda de Contactos Inteligente</title>
  <link rel="stylesheet" href="./styles/global.css">
  <link rel="stylesheet" href="./styles/demo_styles.css">

</head>
<body>
  <h2>Agenda de Contactos Inteligente — contactos, favoritos, búsqueda.</h2>
  <p class="hint">Añade contactos en la izquierda; la lista se actualiza a la derecha. Prueba Favorito / Editar / Eliminar / Buscar.</p>

  <div class="wrap">
    <div class="panel">
      <!-- Formulario (Integrante 2) -->
      <contact-input></contact-input>
    </div>

    <div class="panel right">
      <div>
        <strong>Lista de contactos </strong>
      </div>
      <div id="listRoot" class="contact-list-holder"></div>

      <div>
        <strong>Eventos </strong>
        <div id="log" class="log"></div>
      </div>

      <div>
        <strong>Estadísticas </strong>
        <stats-card></stats-card>
      </div>

      <div>
        <app-modal id="deleteModal" title="Confirmar eliminación">
          <p>¿Deseas eliminar este contacto?</p>
          <button slot="actions" id="cancelBtn">Cancelar</button>
          <button slot="actions" id="confirmBtn">Eliminar</button>
        </app-modal>
      </div>
    </div>
  </div>

  <script type="module">
    // Importa tus componentes
    import './components/contact-input.js';
    import './components/contact-item.js';
    import './components/contact-list.js';
    import './components/stats-card.js';
    import './components/app-modal.js';

    // Element references
    const input = document.querySelector('contact-input');

    // Creamos dinámicamente el contact-list y lo añadimos al panel derecho
    const list = document.createElement('contact-list');
    document.getElementById('listRoot').appendChild(list);

    // Referencia al stats-card para actualizar sus datos
    const stats = document.querySelector('stats-card');

    const logEl = document.getElementById('log');
    function log(msg){
      const now = new Date().toLocaleTimeString();
      logEl.textContent = `[${now}] ${msg}\n` + logEl.textContent;
    }

    // Estado local que simula el AppShell 
    let store = [
      // seed data para demo (automáticamente puedes borrarlos)
      { id: 's1', nombre: 'Ana Pérez', telefono: '+593984001234', email: 'ana@example.com', tags:['amigos'], favorito:false, notas:'Vecina' },
      { id: 's2', nombre: 'Carlos Ruiz', telefono: '+593984002345', email: 'carlos@example.com', tags:['trabajo'], favorito:true, notas:'Cliente' },
      { id: 's3', nombre: 'María Gómez', telefono: '+593984003456', email: 'maria@example.com', tags:['familia'], favorito:false, notas:'' }
    ];
    
    // Helper para sincronizar UI (lista + stats)
    function syncUI() {
      list.contacts = store;
      if (stats) stats.contacts = store;
    }

    // Inicializar lista y stats
    syncUI();

    // ---- Conexión entre input (Integrante2) y lista ----

    // 1) Cuando input emite contact:add -> añadimos al store y actualizamos list
    input.addEventListener('contact:add', (e) => {
      const c = Object.assign({}, e.detail.contact, { id: 'local_' + Date.now(), creado: (new Date()).toISOString().slice(0,7) });
      store.unshift(c);
      syncUI();
      log(`contact:add -> ${c.nombre} (id=${c.id})`);
    });

    // 2) Cuando input emite contact:update -> actualizamos store y list
    input.addEventListener('contact:update', (e) => {
      const updated = e.detail.contact;
      const idx = store.findIndex(x => x.id === updated.id);
      if(idx > -1){ store[idx] = updated; syncUI(); log(`contact:update -> ${updated.nombre} (id=${updated.id})`); } // Integrante 4, actualizar store
      else { log(`contact:update -> id no encontrado: ${updated.id}`); }
    });

    // 3) Cuando input emite filter:change -> aplicamos filtro en lista (padre)
    input.addEventListener('filter:change', (e) => {
      const f = Object.assign({ query:'', tags:[] }, e.detail || {});
      list.filter = f;
      log(`filter:change -> ${JSON.stringify(f)}`);
    });

    // 4) Escuchar eventos desde contact-list / contact-item
    list.addEventListener('item:toggle-fav', (e) => {
      const id = e.detail.id;
      const c = store.find(x => x.id === id);
      if(c){ c.favorito = !c.favorito; syncUI(); log(`item:toggle-fav -> id=${id} favorito=${c.favorito}`); } // Integrante 4, actualizar store
    });

    list.addEventListener('item:edit', (e) => {
      const contact = e.detail.contact;
      // pasar al input para editar
      input.editingContact = contact;
      log(`item:edit -> ${contact.nombre} (id=${contact.id})`);
    });

    // item:request-delete -> permite usar modal; aquí simplemente confirmamos y emitimos item:delete
    list.addEventListener('item:request-delete', (e) => {
      const id = e.detail.id;
      const modal = document.getElementById('deleteModal');
      modal.dataset.id = id;
      modal.open = true;
    });

    list.addEventListener('item:delete', (e) => {
      const id = e.detail.id;
      store = store.filter(x => x.id !== id);
      syncUI();
      log(`item:delete -> id=${id}`);
    });

    document.getElementById('deleteModal').addEventListener('modal:confirm', (e) => {
      const id = e.target.dataset.id;

      list.dispatchEvent(
        new CustomEvent('item:delete', {
          detail: { id },
          bubbles: true,
          composed: true
        })
      );
    });


    // 5) Soporte: si AppShell (o demo) desea mostrar un contact encontrado centralmente en el input
    // puede probar desde consola:
    // document.querySelector('contact-input').searchResult = store[0];
    // o limpia: document.querySelector('contact-input').searchResult = null;


    // 6) Ayuda rapida: añade un boton para agregar más contactos
    const seedBtn = document.createElement('button');
    seedBtn.textContent = 'Agregar 3 contactos';
    seedBtn.style.marginTop = '8px';
    seedBtn.className = 'btn ghost';
    document.getElementById('listRoot').before(seedBtn);
    seedBtn.addEventListener('click', () => {
      const add = [
        { id:'s4', nombre:'Luis Ortega', telefono:'0998004455', email:'luis@hotmail.com', tags:['gym'], favorito:false, notas:'' },
        { id:'s5', nombre:'Julia Castro', telefono:'0998005566', email:'julia@gmail.com', tags:['amigos'], favorito:false, notas:'' },
        { id:'s6', nombre:'Pedro Alvar', telefono:'0998006677', email:'pedro@gmail.com', tags:['trabajo'], favorito:false, notas:'' }
      ];
      store = add.concat(store);
      list.contacts = store;
      log('Agregar 3 contactos de prueba');
    });

    // Log inicial
    log('Demo listo — acciones: Agregar / Buscar / Editar / Favorito / Eliminar');

  </script>
</body>
</html>
